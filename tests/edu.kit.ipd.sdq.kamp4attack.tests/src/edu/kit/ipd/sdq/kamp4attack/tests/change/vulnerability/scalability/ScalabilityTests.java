package edu.kit.ipd.sdq.kamp4attack.tests.change.vulnerability.scalability;

import java.util.ArrayList;
import java.util.stream.Collectors;

import org.eclipse.emf.ecore.util.EcoreUtil;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;
import org.palladiosimulator.pcm.allocation.Allocation;
import org.palladiosimulator.pcm.allocation.AllocationFactory;
import org.palladiosimulator.pcm.confidentiality.attacker.helper.VulnerabilityHelper;
import org.palladiosimulator.pcm.confidentiality.attackerSpecification.AttackerSpecification;
import org.palladiosimulator.pcm.confidentiality.attackerSpecification.AttackerSystemSpecificationContainer;
import org.palladiosimulator.pcm.confidentiality.attackerSpecification.pcmIntegration.PcmIntegrationFactory;
import org.palladiosimulator.pcm.confidentiality.attackerSpecification.pcmIntegration.VulnerabilitySystemIntegration;
import org.palladiosimulator.pcm.core.composition.AssemblyConnector;
import org.palladiosimulator.pcm.core.composition.CompositionFactory;
import org.palladiosimulator.pcm.repository.RepositoryFactory;
import org.palladiosimulator.pcm.resourceenvironment.ResourceContainer;
import org.palladiosimulator.pcm.resourceenvironment.ResourceEnvironment;
import org.palladiosimulator.pcm.resourceenvironment.ResourceenvironmentFactory;
import org.palladiosimulator.pcm.system.System;

import edu.kit.ipd.sdq.kamp4attack.tests.change.AbstractChangeTests;

public abstract class ScalabilityTests extends AbstractChangeTests {
	public static final int WARMUP = 0;
	public static final int REPEAT = 1;

	public ScalabilityTests() {
		this.PATH_REPOSITORY = "travelplanner/default.repository";
		this.PATH_RESOURCES = "travelplanner/default.resourceenvironment";
		this.PATH_ASSEMBLY = "travelplanner/default.system";
		this.PATH_ALLOCATION = "travelplanner/default.allocation";
		this.PATH_ATTACKER = "travelplanner/Scalability/test_model.attacker";
		this.PATH_CONTEXT = "travelplanner/Scalability/test_model.context";
		this.PATH_MODIFICATION = "travelplanner/Scalability/test_model.kamp4attackmodificationmarks";
	}

	@Disabled
	@Test
	void warmup() {
		runAnalysis();
	}

	@Disabled
	@Test
	void run() {

		for (var i = 0; i < WARMUP; i++) {
			runAnalysis();
		}

//        for (var i = 0; i < 1; i++) {
//            perform(this.environment, 1000, this.attacker.getSystemintegration());
//
//            var timeList = new ArrayList<Long>();
//
//            for (var j = 0; j < REPEAT; j++) {
//                timeList.add(analysisTime());
//            }
//
//            try (var output = Files.newBufferedWriter(Paths.get(System.getProperty("java.io.tmpdir"), getFilename()),
//                    StandardOpenOption.APPEND);) {
//                var credential = (CredentialChange) getBlackboardWrapper().getModificationMarkRepository()
//                        .getChangePropagationSteps().get(0);
//                output.append(String.format("%d,%d\n", credential.getCompromisedresource().size(),
//                        Math.round(timeList.stream().mapToLong(Long::longValue).average().getAsDouble())));
//
//            } catch (IOException e) {
//                fail(e.getMessage());
//            }
//
//        }

		perform(this.assembly, this.attacker, this.allocation, this.environment, 300,
				this.attacker.getSystemintegration());
		writeResults();

//		perform(this.environment, 300, this.attacker.getSystemintegration());
//		writeResults();
//		perform(this.environment, 90, this.attacker.getSystemintegration());
//		writeResults();
//		perform(this.environment, 900, this.attacker.getSystemintegration());
//		writeResults();
//		perform(this.environment, 9000, this.attacker.getSystemintegration());
//		writeResults();
//		perform(this.environment, 90000, this.attacker.getSystemintegration());
//		writeResults();
//		perform(this.environment, 900000, this.attacker.getSystemintegration());
//		writeResults();
	}

	private void writeResults() {
		var timeList = new ArrayList<Long>();

		for (var j = 0; j < REPEAT; j++) {
			timeList.add(analysisTime());
		}

//        try (var output = Files.newBufferedWriter(Paths.get(System.getProperty("java.io.tmpdir"), getFilename()),
//                StandardOpenOption.APPEND);) {
//            var credential = (CredentialChange) getBlackboardWrapper().getModificationMarkRepository()
//                    .getChangePropagationSteps().get(0);
//            output.append(String.format("%d,%d\n", credential.getCompromisedresource().size(),
//                    Math.round(timeList.stream().mapToLong(Long::longValue).average().getAsDouble())));
//
//        } catch (IOException e) {
//            fail(e.getMessage());
//        }
	}

	long analysisTime() {
		var startTime = java.lang.System.currentTimeMillis();
		runAnalysis();
		return java.lang.System.currentTimeMillis() - startTime;
	}

	private void perform(ResourceEnvironment environment, int numberAddition,
			AttackerSystemSpecificationContainer attacks) {
		var origin = environment.getResourceContainer_ResourceEnvironment().get(1);
		var vulnerability = VulnerabilityHelper.getVulnerabilities(attacks, origin);
		for (var i = 0; i < numberAddition; i++) {

			var integration = PcmIntegrationFactory.eINSTANCE.createVulnerabilitySystemIntegration();
			integration.setVulnerability(vulnerability.get(0));

			origin = resourceAddOperation(environment, origin, integration);
			attacks.getVulnerabilities().add(integration);
		}
	}

	private void perform(System assembly, AttackerSpecification attacker, Allocation allocation,
			ResourceEnvironment environment, int numberAddition, AttackerSystemSpecificationContainer attacks) {
		var originResource = environment.getResourceContainer_ResourceEnvironment().get(1);
		var vulnerabilitySpecification = attacks.getVulnerabilities().stream()
				.filter(VulnerabilitySystemIntegration.class::isInstance)
				.map(VulnerabilitySystemIntegration.class::cast).collect(Collectors.toList());
		var vulnerability = VulnerabilityHelper.getVulnerabilities(vulnerabilitySpecification, originResource);

		var travelPlanner = assembly.getAssemblyContexts__ComposedStructure().get(1); // TravelPlanner
		var systemComponent = PcmIntegrationFactory.eINSTANCE.createSystemComponent();
		systemComponent.getAssemblycontext().add(travelPlanner);
		attacker.getAttackers().getAttacker().get(0).getCompromisedComponents().add(systemComponent);

		var rootAssembly = assembly.getAssemblyContexts__ComposedStructure().get(0); // TravelAgency

		var allocationResource = ResourceenvironmentFactory.eINSTANCE.createResourceContainer();

		var interfaceConnector = (AssemblyConnector) assembly.getConnectors__ComposedStructure().get(3); // TravelAgency
																											// ->
																											// Airline
		var operationInterface = interfaceConnector.getRequiredRole_AssemblyConnector()
				.getRequiredInterface__OperationRequiredRole(); // FlightOffers

		for (var i = 0; i < numberAddition; i++) {
			var integration = PcmIntegrationFactory.eINSTANCE.createVulnerabilitySystemIntegration();
			integration.setVulnerability(vulnerability.get(0));

			var nextAssembly = CompositionFactory.eINSTANCE.createAssemblyContext();
			nextAssembly.setEncapsulatedComponent__AssemblyContext(RepositoryFactory.eINSTANCE.createBasicComponent());

			var connector = CompositionFactory.eINSTANCE.createAssemblyConnector();
			connector.setProvidingAssemblyContext_AssemblyConnector(rootAssembly);
			connector.setRequiringAssemblyContext_AssemblyConnector(nextAssembly);

			var providedRole = RepositoryFactory.eINSTANCE.createOperationProvidedRole();
			providedRole.setProvidedInterface__OperationProvidedRole(operationInterface);

			var requiredRole = RepositoryFactory.eINSTANCE.createOperationRequiredRole();
			requiredRole.setRequiredInterface__OperationRequiredRole(operationInterface);

			connector.setProvidedRole_AssemblyConnector(providedRole);
			connector.setRequiredRole_AssemblyConnector(requiredRole);

			assembly.getAssemblyContexts__ComposedStructure().add(nextAssembly);
			assembly.getConnectors__ComposedStructure().add(connector);

			var nextAllocation = AllocationFactory.eINSTANCE.createAllocationContext();
			nextAllocation.setAssemblyContext_AllocationContext(nextAssembly);
			nextAllocation.setResourceContainer_AllocationContext(allocationResource);
			allocation.getAllocationContexts_Allocation().add(nextAllocation);

			var pcmElement = PcmIntegrationFactory.eINSTANCE.createPCMElement();
			pcmElement.getAssemblycontext().add(nextAssembly);
			integration.setPcmelement(pcmElement);
			attacks.getVulnerabilities().add(integration);

			rootAssembly = nextAssembly;
		}

		var travelPlannerConnector = (AssemblyConnector) assembly.getConnectors__ComposedStructure().get(1); // TravelPlanner
																												// ->
																												// TravelAgency
		travelPlannerConnector.setProvidingAssemblyContext_AssemblyConnector(rootAssembly);
		var providedRole = RepositoryFactory.eINSTANCE.createOperationProvidedRole();
		providedRole.setProvidedInterface__OperationProvidedRole(operationInterface);
		travelPlannerConnector.setProvidedRole_AssemblyConnector(providedRole);
	}

	protected abstract ResourceContainer resourceAddOperation(ResourceEnvironment environment, ResourceContainer origin,
			VulnerabilitySystemIntegration integration);

	protected abstract String getFilename();

}
