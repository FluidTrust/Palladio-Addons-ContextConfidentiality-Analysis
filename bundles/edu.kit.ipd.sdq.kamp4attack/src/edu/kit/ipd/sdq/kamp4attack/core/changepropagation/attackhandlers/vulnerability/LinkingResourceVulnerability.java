package edu.kit.ipd.sdq.kamp4attack.core.changepropagation.attackhandlers.vulnerability;

import java.util.Optional;

import org.eclipse.emf.ecore.EObject;
import org.palladiosimulator.pcm.confidentiality.attacker.analysis.common.data.DataHandlerAttacker;
import org.palladiosimulator.pcm.confidentiality.attacker.helper.VulnerabilityHelper;
import org.palladiosimulator.pcm.confidentiality.attackerSpecification.attackSpecification.AttackVector;
import org.palladiosimulator.pcm.confidentiality.context.helper.PolicyHelper;
import org.palladiosimulator.pcm.resourceenvironment.LinkingResource;

import edu.kit.ipd.sdq.kamp4attack.core.BlackboardWrapper;
import edu.kit.ipd.sdq.kamp4attack.core.changepropagation.attackhandlers.LinkingResourceHandler;
import edu.kit.ipd.sdq.kamp4attack.model.modificationmarks.KAMP4attackModificationmarks.CompromisedLinkingResource;
import edu.kit.ipd.sdq.kamp4attack.model.modificationmarks.KAMP4attackModificationmarks.CredentialChange;

public class LinkingResourceVulnerability extends LinkingResourceHandler {

    private AttackVector attackVector;
    
    public LinkingResourceVulnerability(BlackboardWrapper modelStorage, DataHandlerAttacker dataHandler, AttackVector attackVector) {
        super(modelStorage, dataHandler);
        this.attackVector = attackVector;
    }

    @Override
    protected Optional<CompromisedLinkingResource> attackLinkingResource(LinkingResource linking,
            CredentialChange change, EObject source) {
        var credentials = this.getCredentials(change);
        var attacks = getAttacks();
        var vulnerabilityList = VulnerabilityHelper
                .getVulnerabilities(this.getModelStorage().getVulnerabilitySpecification(), linking);
        var policies = PolicyHelper.getPolicy(this.getModelStorage().getSpecification(), linking);
        var vulnerability = VulnerabilityHelper.checkAttack(credentials, policies, vulnerabilityList, attacks,
                attackVector);
        var handling = new VulnerabilityHandlingLinkingResource();
        return handling.executeVulnerabilityHandling(linking, change, source, vulnerability);
    }

}
