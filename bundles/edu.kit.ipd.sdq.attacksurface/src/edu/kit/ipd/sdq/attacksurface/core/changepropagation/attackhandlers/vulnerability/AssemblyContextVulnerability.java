package edu.kit.ipd.sdq.attacksurface.core.changepropagation.attackhandlers.vulnerability;

import java.util.Optional;
import java.util.Set;
import java.util.function.Function;

import org.eclipse.emf.common.util.EList;
import org.eclipse.emf.ecore.EObject;
import org.palladiosimulator.pcm.confidentiality.attacker.analysis.common.data.DataHandlerAttacker;
import org.palladiosimulator.pcm.confidentiality.attacker.helper.VulnerabilityHelper;
import org.palladiosimulator.pcm.confidentiality.attackerSpecification.attackSpecification.AttackVector;
import org.palladiosimulator.pcm.confidentiality.attackerSpecification.attackSpecification.Vulnerability;
import org.palladiosimulator.pcm.core.composition.AssemblyContext;
import org.palladiosimulator.pcm.core.entity.Entity;

import de.uka.ipd.sdq.identifier.Identifier;
import edu.kit.ipd.sdq.attacksurface.core.changepropagation.attackhandlers.AssemblyContextHandler;
import edu.kit.ipd.sdq.attacksurface.core.changepropagation.changes.CauseGetter;
import edu.kit.ipd.sdq.attacksurface.graph.AttackGraph;
import edu.kit.ipd.sdq.attacksurface.graph.AttackStatusNodeContent;
import edu.kit.ipd.sdq.attacksurface.graph.CredentialsVulnearbilitiesSurface;
import edu.kit.ipd.sdq.attacksurface.graph.VulnerabilitySurface;
import edu.kit.ipd.sdq.kamp4attack.core.api.BlackboardWrapper;
import edu.kit.ipd.sdq.kamp4attack.model.modificationmarks.KAMP4attackModificationmarks.CompromisedAssembly;
import edu.kit.ipd.sdq.kamp4attack.model.modificationmarks.KAMP4attackModificationmarks.CredentialChange;

/**
 * Represents an attack handler for assembly context attacks with vulnerabilities.
 * 
 * @author ugnwq
 * @author majuwa
 * @version 1.0
 */
public class AssemblyContextVulnerability extends AssemblyContextHandler {

    private final AttackVector attackVector;

    public AssemblyContextVulnerability(final BlackboardWrapper modelStorage, final DataHandlerAttacker dataHandler,
            final AttackVector attackVector, final AttackGraph attackGraph) {
        super(modelStorage, dataHandler, attackGraph);
        this.attackVector = attackVector;
    }

    @Override
    protected Optional<CompromisedAssembly> attackComponent(final AssemblyContext component,
            final CredentialChange change, final Entity source) {
        final var credentials = this.getAllCredentials(new AttackStatusNodeContent(source),
                new AttackStatusNodeContent(component));
        final var attacks = this.getAttacks();

        final var vulnerabilityList = VulnerabilityHelper
                .getVulnerabilities(this.getModelStorage().getVulnerabilitySpecification(), component);

        final var vulnerability = this.checkVulnerability(component, change, credentials, attacks, vulnerabilityList,
                this.attackVector);
        final var handling = new VulnerabilityHandlingAssemblyContext(this.getDataHandler());
        
        var attackerNodeInGraph = this.getAttackGraph().findNode(new AttackStatusNodeContent(source));
        var attackedNodeInGraph = this.getAttackGraph().findNode(new AttackStatusNodeContent(component));
        if (attackedNodeInGraph == null) {
            attackedNodeInGraph = this.getAttackGraph().addOrFindChild(this.getAttackGraph().getSelectedNode(), 
                    new AttackStatusNodeContent(component));
        } 
        if (attackerNodeInGraph == null) {
            attackerNodeInGraph = this.getAttackGraph().addOrFindChild(attackedNodeInGraph, 
                    new AttackStatusNodeContent(source));
        }
        
        return handling.executeVulnerabilityHandling(
                component, change, source, vulnerability, 
                attackerNodeInGraph, attackedNodeInGraph,
                getAttackGraph());
    }

    @Override
    protected Set<Identifier> getCauses(EList<EObject> causingElements) {
        return CauseGetter.getCauses(causingElements, Vulnerability.class);
    }

    @Override
    protected Function<Identifier, CredentialsVulnearbilitiesSurface> getSurfaceMapper() {
        return VulnerabilitySurface::new;
    }

}
